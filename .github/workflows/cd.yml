name: Continuous Delivery (CD)

on:
  workflow_run:
    workflows: [Continuous Integration (CI)]  # Зависит от CI
    branches: [main]                          # Только для main
    types: [completed]                        # После завершения CI

jobs:
  publish:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}  # Только при успехе
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write    # Права на публикацию

    steps:
    - name: Debug Info
      run: |
       echo "Event: ${{ toJson(github.event) }}"
       echo "CI Branch: ${{ github.event.workflow_run.head_branch }}"
       echo "CI Status: ${{ github.event.workflow_run.conclusion }}"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
          java-version: '17'
          distribution: 'temurin'

    - name: Publish to GitHub Packages
      run: ./gradlew publish   # Команда Gradle для публикации
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Авторизация

